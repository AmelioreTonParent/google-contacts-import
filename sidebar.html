<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <!-- The CSS package above applies Google styling to buttons and other elements. -->
    <?!= include('autocomplete-stylesheet'); ?>
    <!-- The CSS package above applies easy autocomplete stylesheet -->
    
    <style>
    .branding-below {
      bottom: 56px;
      top: 0;
    }
    .branding-text {
      left: 7px;
      position: relative;
      top: 3px;
    }
    .col-contain {
      overflow: hidden;
    }
    .width-100 {
      width: 100%;
    }
    .logo {
      vertical-align: middle;
    }
    .disabledinformation {
      opacity: 0.4;
    }
    </style>
  </head>
  <body>
    <div class="sidebar branding-below">
      <form>
        <div class="block" id="button-bar">
          <button class="blue" id="list-contacts">Load Contacts</button>
        </div>
        <div class="block" id="contacts-div">
          <ul id="things"></ul>
          <div class="input-group">
            <input class="width-100 form-control disabledinformation" type="text" id="contact-selection" placeholder="Select a contact by name" disabled>
          </div>
          <label id="loaded-contacts-number">0</label><label for="loaded-contacts-number"> contacts loaded.</label>
        </div>
        <div class="block">
          <input type="checkbox" id="manual-edit" checked>
          <label for="manual-edit">Edit manually a contact</label>
        </div>
        <div class="block" id="contact-information">
          <div class="input-group">
            <label for="family-name"><b>Name:</b></label>
            <input class="width-100" id="family-name" type="text" class="form-control" placeholder="{contact.familyName}" aria-label="Username">
          </div>
          <div class="input-group">
            <label for="given-name"><b>Firstname:</b></label>
            <input class="width-100" id="given-name" type="text" class="form-control" placeholder="{contact.givenName}" aria-label="Firstname">
          </div>
          <div class="input-group">
            <label for="display-name"><b>Full name:</b></label>
            <input class="width-100" id="display-name" type="text" class="form-control" placeholder="{contact.displayName}" aria-label="Displayname">
          </div>
          <div class="input-group">
            <label for="email"><b>Email:</b></label>
            <input class="width-100" id="email" type="email" class="form-control" placeholder="{contact.email}" aria-label="Email">
          </div>
          <div class="block form-group">
            <label for="address"><b>Address:</b></label>
            <textarea class="width-100" id="address" rows="4" placeholder="{contact.address}"></textarea>
          </div>
        </div>
        <div class="block" id="replace-button-bar">
          <button class="blue" id="replace-contact">Replace</button>
        </div>
      </form>
    </div>

    <div class="sidebar bottom">
      <img alt="Add-on logo" class="logo" src="https://www.gstatic.com/images/branding/product/1x/translate_48dp.png" width="27" height="27">
      <span class="gray branding-text">Contacts import by Gabriel</span>
    </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <!-- import easy autocomplete scripting part after jquery -->
    <?!= include('autocomplete-javascript'); ?>

    <script>
      /**
       * On document load, assign click handlers to each button and try to load the
       * user's origin and destination language preferences if previously set.
       */
      $(function() {
        $('#list-contacts').click(listContacts);
        $('#manual-edit').click(manageManualEdition);
        $('#replace-contact').click(replaceContact);
      });
      
      /**
       * Runs a clien-side function to enable or disable manual edition of contact information.
       */
      function cleanContactInformation() {
        // after a change, we should clean content to avoid misuses of old information
        $('#family-name').val('');
        $('#given-name').val('');
        $('#display-name').val('');
        $('#email').val('');
        $('#address').val('');
      }

      /**
       * Runs a clien-side function to enable or disable manual edition of contact information.
       */
      function manageManualEdition() {
        var manualEditFlag = $('#manual-edit').is(':checked');
        if (manualEditFlag) {
          // enable everything
          $('#contact-information').children().prop('disabled',false);
          $("#contact-information").removeClass("disabledinformation");
          // disable contacts selection
          $('#contact-selection').prop('disabled',true);
          $("#contact-selection").addClass("disabledinformation");
          // keep values that could have been set automatically
          // to be able to modify them
        } else {
          // disable everything
          $('#contact-information').children().prop('disabled',true);
          $("#contact-information").addClass("disabledinformation");
          // enable contacts selection
          $('#contact-selection').prop('disabled',false);
          $("#contact-selection").removeClass("disabledinformation");
          // after a change, we should clean content to avoid misuses of old information
          cleanContactInformation();
        }
      }

      /**
       * Runs a client-side function to display contact information.
       */
      function displayContactInformation(contactInformation) {
        // clean existing values
        cleanContactInformation();
        
        // fill new values
        let names = contactInformation.names;
        let familyName = '';
        let givenName = '';
        let displayName = '';
        if (names) {
        if (names[0]) {
          // we have at least one name information
          // we should use primary name, information available in metadata
          familyName = names[0].familyName;
          givenName = names[0].givenName;
          displayName = names[0].displayName;
        }
        }

        $("#family-name").val(familyName).trigger("change");
        $("#given-name").val(givenName).trigger("change");
	    $("#display-name").val(displayName).trigger("change");

        let emails = contactInformation.emailAddresses;
        let email = '';
        if (emails) {
        if (emails[0]) {
          email = emails[0].value;
        }
        }

        $("#email").val(email).trigger("change");

        let addresses = contactInformation.addresses;
        let address = '';
        if (addresses) {
        if (addresses[0]) {
          address = addresses[0].formattedValue;
        }
        }

        $("#address").val(address).trigger("change");
      }

      /**
       * Runs a client-side function to populate list of contacts to search in.
       * 
       * List of "Person" (contact information): https://developers.google.com/people/api/rest/v1/people#Person
       * 
       * A person contains names: https://developers.google.com/people/api/rest/v1/people#Person.Name
       * 
       * Every level of information contains metadata, where to find "primary" flag:
       * https://developers.google.com/people/api/rest/v1/people#Person.FieldMetadata
       */
      function populateContactsSearch(contactInformationList) {
        var options = {
	      data: contactInformationList,
	      getValue: function(contactInformation) {
            if (contactInformation) {
              let names = contactInformation.names;
              let displayName = '';
              if (names) {
              if (names[0]) {
                // we have at least one name information
                // we should use primary name, information available in metadata
                displayName = names[0].displayName;
              }
              } else {
                displayName = 'No name';
              }
	          return displayName;
            } else {
              return 'unknown';
            }
          },      
	      list: {
            maxNumberOfElements: contactInformationList.length,
            match: {
			  enabled: true
		    },
		    onSelectItemEvent: function() {
			  let contactInformation = $("#contact-selection").getSelectedItemData();
              displayContactInformation(contactInformation);
		    }
	      }
        };
        
        $("#contact-selection").easyAutocomplete(options);
      }

      /**
       * Runs a server-side function to display list of contacts for current user.
       */
      function listContacts() {
        this.disabled = true;
        $('#error').remove();
        // display loading message
        var list = $('#things');
        list.append('<li>Loading...</li>');

        google.script.run.withSuccessHandler(
              function(contactInformationList, element) {
                populateContactsSearch(contactInformationList);
                // fill number of loaded contacts
                $('#loaded-contacts-number').text(contactInformationList.length);
                // enable user interactions
                element.disabled = false;
                list.empty();
                // force switch to disable manual edition
                $('#manual-edit').prop("checked", false).trigger("change");
                manageManualEdition();
              })
            .withFailureHandler(
              function(msg, element) {
                showError(msg, $('#button-bar'));
                element.disabled = false;
                list.empty();
              })
            .withUserObject(this)
            .getConnections();

      }
      
      /**
       * Runs a server-side function to replace contact information in current template.
       */
      function replaceContact() {
        this.disabled = true;
        $('#error').remove();
        
        var familyName = $('#family-name').val();
        var givenName = $('#given-name').val();
        var displayName = $('#display-name').val();
        var email = $('#email').val();
        var address = $('#address').val();
        
        google.script.run
            .withSuccessHandler(
              function(returnSuccess, element) {
                element.disabled = false;
              })
            .withFailureHandler(
              function(msg, element) {
                showError(msg, $('#replace-button-bar'));
                element.disabled = false;
              })
            .withUserObject(this)
            .searchAndReplace(familyName, givenName, displayName, email, address);
      }

      /**
       * Runs a server-side function to insert the translated text into the document
       * at the user's cursor or selection.
       */
      function insertText() {
        this.disabled = true;
        $('#error').remove();
        google.script.run
            .withSuccessHandler(
              function(returnSuccess, element) {
                element.disabled = false;
              })
            .withFailureHandler(
              function(msg, element) {
                showError(msg, $('#button-bar'));
                element.disabled = false;
              })
            .withUserObject(this)
            .insertText($('#translated-text').val());
      }

      /**
       * Inserts a div that contains an error message after a given element.
       *
       * @param {string} msg The error message to display.
       * @param {DOMElement} element The element after which to display the error.
       */
      function showError(msg, element) {
        var div = $('<div id="error" class="error">' + msg + '</div>');
        $(element).after(div);
      }
    </script>
  </body>
</html>